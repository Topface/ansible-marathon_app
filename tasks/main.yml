---

- name: Ensure that all services have restarted
  meta: flush_handlers

- name: "wait for marathon"
  uri: >
    url="{{ marathon_url }}/ping"
    method=GET
    status_code=200
    return_content=yes
  register: marathon_ping
  until: "{{ ('msg' not in marathon_ping or 'error' not in marathon_ping.msg) and 'content' in marathon_ping and 'pong' in marathon_ping.content }}"
  delay: 1
  retries: 3600

- name: "launch app: {{ marathon_app.id }}"
  uri: >
    url="{{ marathon_url }}/v2/apps{{ marathon_app.id }}"
    method=PUT
    HEADER_Content-Type="application/json"
    body='{{ marathon_app | to_json }}'
    status_code=200,201
  register: marathon_deployment
  delay: 10
  retries: 10

- name: "wait for app: {{ marathon_app.id }}"
  uri: >
    url="{{ marathon_url }}/v2/deployments"
    method=GET
    status_code=200
  register: marathon_deployments
  until: "{{ marathon_deployment.json.deploymentId not in marathon_deployments.json|map(attribute='id') }}"
  delay: 1
  retries: 3600
  when: marathon_wait_for_deployment
